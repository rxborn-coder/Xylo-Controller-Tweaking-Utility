@echo off & setlocal EnableExtensions EnableDelayedExpansion
:: Force admin check at the very top
fltmc >nul 2>&1 || (
    echo.
    echo  âŒ  This utility MUST be run as Administrator.
    echo     Right-click the file â†’ "Run as administrator"
    echo.
    pause
    exit /b 1
)

title Xylo Universal Controller Utility  (Administrator Confirmed)
set "applied=0"

:: 1ï¸âƒ£ CREATE RESTORE POINT (once per day)
echo [+] Creating restore point "XyloControllerTweak" ...
wmic.exe /Namespace:\\root\default Path SystemRestore Call CreateRestorePoint "XyloControllerTweak", 100, 7 >nul 2>&1
if %errorlevel%==0 (
    echo [âœ”] Restore point created.
) else (
    echo [!] Restore point already exists today or WMIC failedâ€”continuing anyway.
)
echo.

:menu
cls
echo.
echo    ðŸŽ®  Xylo Universal Controller Utility  (Administrator Confirmed)
echo    -----------------------------------------------------------------
echo    1  1000 Hz USB polling           (ALL controllers)
echo    2  Disable USB selective suspend (ALL controllers)
echo    3  HID micro-queue clamp          (ALL HID pads)
echo    4  Xbox fast-lane keys            (Xbox only)
echo    5  DS4/DS5 overclock keys         (Sony only)
echo    6  REVERT everything back to stock
echo.
echo    Applied so far: !applied! tweak(s)
echo.
choice /c 123456q /n /m "Choose tweak or Q to quit: "
set "ch=%errorlevel%"
if %ch%==7 exit /b
if %ch%==6 goto revert
if %ch%==1 call :usb1000
if %ch%==2 call :usbsusp
if %ch%==3 call :hidclamp
if %ch%==4 call :xboxfast
if %ch%==5 call :sonyoc
goto menu

::----------------------------------------------------
:usb1000
echo.
echo [+] Setting USB 1000 Hz pollingâ€¦
reg add "HKLM\SYSTEM\CurrentControlSet\Services\USB\Parameters" /v IdleEnable /t REG_DWORD /d 0 /f >nul
reg add "HKLM\SYSTEM\CurrentControlSet\Control\usbflags" /v SkipContainerIdQuery /t REG_DWORD /d 1 /f >nul
set /a applied+=1
echo [âœ”] USB now polls at 1000 Hz â€“ reboot to feel it.
pause
goto :eof

::----------------------------------------------------
:usbsusp
echo.
echo [+] Disabling USB selective suspendâ€¦
powercfg /SETACVALUEINDEX SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 0 >nul
powercfg /SETDCVALUEINDEX SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 0 >nul
powercfg /SETACTIVE SCHEME_CURRENT >nul
set /a applied+=1
echo [âœ”] USB suspend OFF â€“ no more lag spikes.
pause
goto :eof

::----------------------------------------------------
:hidclamp
echo.
echo [+] Clamping HID latency queueâ€¦
reg add "HKLM\SYSTEM\CurrentControlSet\Services\HidUsb\Parameters" /v LatencyTimer /t REG_DWORD /d 1 /f >nul
set /a applied+=1
echo [âœ”] HID latency queue clamped to 1 ms.
pause
goto :eof

::----------------------------------------------------
:xboxfast
echo.
echo [+] Injecting Xbox fast-lane keysâ€¦
reg add "HKLM\SYSTEM\CurrentControlSet\Services\XboxGip\Parameters" /v FastPoll /t REG_DWORD /d 1 /f >nul 2>&1
reg add "HKLM\SYSTEM\CurrentControlSet\Services\XboxGip\Parameters" /v LatencyMs /t REG_DWORD /d 1 /f >nul 2>&1
set /a applied+=1
echo [âœ”] XboxGip driver set to 1 ms poll & fast-poll flag.
pause
goto :eof

::----------------------------------------------------
:sonyoc
echo.
echo [+] Dropping Sony controller latency timerâ€¦
for %%k in (Ds4 Ds5 SonyHid) do (
  reg add "HKLM\SYSTEM\CurrentControlSet\Services\%%k\Parameters" /v LatencyTimer /t REG_DWORD /d 1 /f >nul 2>&1
)
set /a applied+=1
echo [âœ”] DS4/DS5 latency timer dropped to 1 ms.
pause
goto :eof

::----------------------------------------------------
:revert
echo.
echo [!] Creating reg backups to Desktopâ€¦
for %%s in (USB XboxGip HidUsb Ds4 Ds5 SonyHid) do (
  reg export "HKLM\SYSTEM\CurrentControlSet\Services\%%s" "%USERPROFILE%\Desktop\Xylo_%%s_backup.reg" >nul 2>&1
)
echo.
echo [-] Removing all tweaksâ€¦
:: USB
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\USB\Parameters" /v IdleEnable /f >nul 2>&1
reg delete "HKLM\SYSTEM\CurrentControlSet\Control\usbflags" /v SkipContainerIdQuery /f >nul 2>&1
:: Power
powercfg /SETACVALUEINDEX SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 1 >nul
powercfg /SETDCVALUEINDEX SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 1 >nul
powercfg /SETACTIVE SCHEME_CURRENT >nul
:: HID
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\HidUsb\Parameters" /v LatencyTimer /f >nul 2>&1
:: Xbox
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\XboxGip\Parameters" /v FastPoll /f >nul 2>&1
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\XboxGip\Parameters" /v LatencyMs /f >nul 2>&1
:: Sony
for %%k in (Ds4 Ds5 SonyHid) do (
  reg delete "HKLM\SYSTEM\CurrentControlSet\Services\%%k\Parameters" /v LatencyTimer /f >nul 2>&1
)
set "applied=0"
echo [âœ”] All tweaks removed â€“ system back to stock.
pause
goto menu
